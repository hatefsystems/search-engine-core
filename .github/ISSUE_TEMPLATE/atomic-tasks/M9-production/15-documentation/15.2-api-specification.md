---
name: "15.2 - API Specification & Interactive Documentation"
about: Create comprehensive OpenAPI specification for search API with debug mode and interactive Swagger UI
title: "[M9][documentation] API specification with debug mode documentation"
labels: kind/feature, area/documentation, priority/P1, status/backlog
assignees: ''
milestone: M9-production
estimated_duration: 3-4 days
dependencies:
  - All API endpoints implemented and stable
  - Query pipeline complete (09-query-pipeline)
  - Authentication and rate limiting implemented
---

## Summary
Create comprehensive OpenAPI 3.0 specification for the universal multilingual search API, including all endpoints, request/response schemas, authentication, debug mode parameters, and multi-language query examples. Deploy interactive Swagger UI for API exploration.

## Context
API documentation is critical for:
- Frontend integration and development
- Third-party integrations (if applicable)
- API contract validation and testing
- Developer onboarding
- Debug mode utilization for troubleshooting

## Goals
- **Primary:** Complete OpenAPI 3.0 specification for all public APIs
- **Secondary:** Interactive Swagger UI for API testing
- **Stretch:** Auto-generated client SDKs (Python, JavaScript)

## Tasks

### OpenAPI Specification

- [ ] **Core API Schema Definition**
  - OpenAPI 3.0 metadata (version, title, description)
  - Server definitions (development, staging, production)
  - Security schemes (API keys, rate limiting)
  - Global parameters and headers
  - Standard error response schemas

- [ ] **Search API Endpoint**
  ```yaml
  /api/v2/search:
    get:
      summary: Universal multilingual search
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 1
            maxLength: 500
          description: Search query in any language/script
          examples:
            english: "machine learning tutorials"
            persian: "Ø¢Ù…ÙˆØ²Ø´ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø§Ø´ÛŒÙ†"
            arabic: "ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„Ø©"
            chinese: "æœºå™¨å­¦ä¹ æ•™ç¨‹"
        
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Number of results to return
        
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset
        
        - name: lang
          in: query
          schema:
            type: string
            pattern: '^[a-z]{2}$'
          description: Force specific language (auto-detected if omitted)
        
        - name: debug
          in: query
          schema:
            type: integer
            enum: [0, 1]
            default: 0
          description: Enable debug mode (1) to see ranking features
      
      responses:
        200:
          description: Successful search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        400:
          description: Invalid request parameters
        429:
          description: Rate limit exceeded
        500:
          description: Internal server error
  ```

- [ ] **Debug Mode Parameters**
  - Feature trace output (`bm25_score`, `embedding_similarity`, `hostrank`, etc.)
  - Query processing stages (normalization, expansion, retrieval)
  - Stopword filtering decisions
  - Language/script detection confidence
  - Spell correction suggestions
  - Cache hit/miss indicators
  - Latency breakdown by stage

- [ ] **Response Schemas**
  ```yaml
  SearchResponse:
    type: object
    required:
      - success
      - results
      - metadata
    properties:
      success:
        type: boolean
        example: true
      
      results:
        type: array
        items:
          $ref: '#/components/schemas/SearchResult'
      
      metadata:
        $ref: '#/components/schemas/SearchMetadata'
      
      debug:
        $ref: '#/components/schemas/DebugInfo'
        description: Only present when debug=1
  
  SearchResult:
    type: object
    required:
      - url
      - title
      - snippet
      - rank
    properties:
      url:
        type: string
        format: uri
        example: "https://example.com/article"
      
      title:
        type: string
        example: "Machine Learning Tutorial"
      
      snippet:
        type: string
        example: "Comprehensive guide to machine learning..."
      
      rank:
        type: integer
        minimum: 1
        example: 1
      
      domain:
        type: string
        example: "example.com"
      
      language:
        type: string
        example: "en"
      
      schema_type:
        type: string
        example: "Article"
      
      published_date:
        type: string
        format: date-time
        nullable: true
      
      features:
        $ref: '#/components/schemas/RankingFeatures'
        description: Only in debug mode
  
  RankingFeatures:
    type: object
    properties:
      bm25_score:
        type: number
        example: 15.32
      
      embedding_similarity:
        type: number
        example: 0.847
      
      hostrank:
        type: number
        example: 0.65
      
      anchor_match:
        type: number
        example: 0.42
      
      structured_boost:
        type: number
        example: 1.1
      
      freshness_decay:
        type: number
        example: 0.95
      
      url_quality:
        type: number
        example: 0.8
      
      spamness:
        type: number
        example: 0.05
      
      intent_align:
        type: number
        example: 0.78
      
      final_score:
        type: number
        example: 18.45
  
  SearchMetadata:
    type: object
    properties:
      total_results:
        type: integer
        example: 1500
      
      latency_ms:
        type: integer
        example: 245
      
      query_language:
        type: string
        example: "en"
      
      query_script:
        type: string
        example: "Latin"
      
      spelling_corrected:
        type: boolean
        example: false
      
      suggestion:
        type: string
        nullable: true
        example: "machine learning"
  
  DebugInfo:
    type: object
    properties:
      query_processing:
        $ref: '#/components/schemas/QueryProcessingDebug'
      
      retrieval_stages:
        $ref: '#/components/schemas/RetrievalDebug'
      
      timing_breakdown:
        $ref: '#/components/schemas/TimingDebug'
  ```

### Additional API Endpoints

- [ ] **Crawl Request API** (`/api/v2/crawl-request`)
  - POST endpoint for submitting URLs
  - Request validation schemas
  - Response with job ID and status
  - Multi-language example requests

- [ ] **Sponsor Management API** (`/api/v2/sponsor/*`)
  - List sponsors
  - Add/update/delete sponsor
  - Sponsor verification endpoints
  - Email notification triggers

- [ ] **Health Check API** (`/api/v2/health`)
  - Service status endpoint
  - Component health checks (MongoDB, Redis, Embedding service)
  - Version information

- [ ] **Metrics API** (`/api/v2/metrics`)
  - Query metrics endpoint
  - Click-through rate statistics
  - Latency percentiles
  - Language distribution

### Interactive Documentation

- [ ] **Swagger UI Setup**
  - Deploy Swagger UI at `/api/docs`
  - Load OpenAPI spec dynamically
  - Custom branding and styling
  - Persian/RTL support for UI

- [ ] **Example Requests**
  - Multi-language query examples (20+ languages)
  - Debug mode examples
  - Pagination examples
  - Error handling examples
  - Rate limiting demonstrations

- [ ] **Try-It-Out Functionality**
  - Pre-filled example queries
  - Editable request parameters
  - Real-time API calls to dev/staging environment
  - Response visualization with syntax highlighting

### Code Examples & SDKs

- [ ] **HTTP Client Examples**
  ```python
  # Python Example
  import requests
  
  # Basic search (auto-detect language)
  response = requests.get('https://api.example.com/api/v2/search', params={
      'q': 'Ø¢Ù…ÙˆØ²Ø´ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ',  # Persian query
      'limit': 10
  })
  
  results = response.json()
  for result in results['results']:
      print(f"{result['rank']}. {result['title']}")
      print(f"   URL: {result['url']}")
      print(f"   Language: {result['language']}")
  
  # Debug mode search
  debug_response = requests.get('https://api.example.com/api/v2/search', params={
      'q': 'machine learning',
      'debug': 1
  })
  
  debug_info = debug_response.json()
  print(f"Query processing: {debug_info['debug']['query_processing']}")
  for result in debug_info['results']:
      features = result['features']
      print(f"BM25: {features['bm25_score']}, EmbSim: {features['embedding_similarity']}")
  ```

  ```javascript
  // JavaScript/Node.js Example
  const axios = require('axios');
  
  // Basic search
  async function search(query, limit = 10) {
      const response = await axios.get('https://api.example.com/api/v2/search', {
          params: { q: query, limit }
      });
      
      return response.data.results;
  }
  
  // With debug mode
  async function debugSearch(query) {
      const response = await axios.get('https://api.example.com/api/v2/search', {
          params: { q: query, debug: 1 }
      });
      
      console.log('Debug Info:', response.data.debug);
      return response.data.results;
  }
  
  // Usage
  search('ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø¹Ù…ÛŒÙ‚').then(results => {
      results.forEach(result => {
          console.log(`${result.rank}. ${result.title}`);
      });
  });
  ```

  ```bash
  # cURL Examples
  # Basic search
  curl "https://api.example.com/api/v2/search?q=neural+networks&limit=5"
  
  # Persian query with debug mode
  curl "https://api.example.com/api/v2/search?q=%D8%B4%D8%A8%DA%A9%D9%87+%D8%B9%D8%B5%D8%A8%DB%8C&debug=1"
  
  # With language hint
  curl "https://api.example.com/api/v2/search?q=data+science&lang=en&limit=20"
  ```

### Validation & Testing

- [ ] **OpenAPI Validation**
  - Validate spec with OpenAPI validator
  - Test all endpoints match specification
  - Ensure all response codes documented
  - Verify example requests/responses are valid

- [ ] **API Contract Testing**
  - Automated tests against OpenAPI spec
  - Schema validation for all responses
  - Parameter validation testing
  - Error response format verification

## Technical Approach

### OpenAPI Spec Location
```
docs/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ openapi.yaml           # Main OpenAPI 3.0 specification
â”‚   â”œâ”€â”€ schemas/               # Reusable schema components
â”‚   â”‚   â”œâ”€â”€ search.yaml
â”‚   â”‚   â”œâ”€â”€ crawl.yaml
â”‚   â”‚   â”œâ”€â”€ sponsor.yaml
â”‚   â”‚   â””â”€â”€ common.yaml
â”‚   â””â”€â”€ examples/              # Request/response examples
â”‚       â”œâ”€â”€ search-examples.yaml
â”‚       â””â”€â”€ debug-examples.yaml
```

### Swagger UI Deployment
```dockerfile
# Add to docker-compose.yml or serve via static controller
services:
  swagger-ui:
    image: swaggerapi/swagger-ui
    ports:
      - "8080:8080"
    environment:
      SWAGGER_JSON: /api/openapi.yaml
    volumes:
      - ./docs/api:/api
```

### API Versioning Strategy
```yaml
API Versions:
  - v1: Legacy (if exists)
  - v2: Current stable (document this)
  - v3: Future (reserved)

Deprecation Policy:
  - Announce 6 months before deprecation
  - Maintain backwards compatibility for 1 year
  - Provide migration guide
```

## Acceptance Criteria

### Specification Completeness
- [ ] All public API endpoints documented in OpenAPI spec
- [ ] Request parameters fully specified (type, constraints, examples)
- [ ] Response schemas complete with examples
- [ ] Error responses documented (4xx, 5xx)
- [ ] Debug mode parameters and responses fully documented
- [ ] Multi-language query examples for 10+ languages
- [ ] Authentication and rate limiting documented

### Debug Mode Documentation
- [ ] All ranking features explained with examples
- [ ] Query processing stages documented
- [ ] Stopword filtering logic explained
- [ ] Spell correction mechanism documented
- [ ] Timing breakdown interpretation guide
- [ ] Cache hit/miss indicators explained

### Interactive Documentation
- [ ] Swagger UI deployed and accessible at `/api/docs`
- [ ] All endpoints testable via "Try it out" feature
- [ ] Example requests pre-filled and functional
- [ ] Response visualization with syntax highlighting
- [ ] Custom branding applied (logo, colors)
- [ ] RTL support for Persian/Arabic documentation

### Code Examples
- [ ] Python client example with error handling
- [ ] JavaScript/Node.js client example
- [ ] cURL examples for all major use cases
- [ ] Multi-language query examples (10+ languages)
- [ ] Debug mode usage examples
- [ ] Pagination examples

### Validation
- [ ] OpenAPI spec passes validation (via Swagger Editor or validator)
- [ ] All endpoints return responses matching schemas
- [ ] API contract tests pass 100%
- [ ] No undocumented endpoints or parameters
- [ ] CI/CD validates spec on every commit

## Testing & Validation

### OpenAPI Validation
```bash
# Install validator
npm install -g @apidevtools/swagger-cli

# Validate spec
swagger-cli validate docs/api/openapi.yaml

# Bundle spec (resolve $ref)
swagger-cli bundle docs/api/openapi.yaml -o docs/api/openapi-bundled.yaml
```

### API Contract Testing
```python
# Using schemathesis for automated testing
import schemathesis

schema = schemathesis.from_uri("https://api.example.com/api/openapi.yaml")

@schema.parametrize()
def test_api_contract(case):
    case.call_and_validate()
```

### Manual Testing Checklist
- [ ] Test each endpoint via Swagger UI
- [ ] Verify all parameter combinations
- [ ] Test with multi-language queries (Latin, Arabic, Persian, Chinese, Cyrillic)
- [ ] Verify debug mode output completeness
- [ ] Test error handling (invalid params, rate limiting)
- [ ] Verify response times within SLOs

## Documentation

### API Usage Guide
Create `docs/api/usage-guide.md`:
```markdown
# API Usage Guide

## Quick Start
1. Base URL: `https://api.example.com/api/v2`
2. No authentication required for public search
3. Rate limit: 100 requests/minute per IP

## Search API
### Basic Search
GET /api/v2/search?q=your+query

### Multi-Language Support
Queries in any language/script are automatically detected:
- English: `?q=machine+learning`
- Persian: `?q=ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ+Ù…Ø§Ø´ÛŒÙ†`
- Arabic: `?q=ØªØ¹Ù„Ù…+Ø§Ù„Ø¢Ù„Ø©`
- Chinese: `?q=æœºå™¨å­¦ä¹ `

### Debug Mode
Add `debug=1` to see ranking features:
GET /api/v2/search?q=your+query&debug=1

## Rate Limiting
- Limit: 100 requests/minute
- Header: `X-RateLimit-Remaining`
- Retry after: `Retry-After` header when limited

## Error Handling
- 400: Invalid parameters
- 404: Endpoint not found
- 429: Rate limit exceeded
- 500: Internal server error
```

### Debug Mode Guide
Create `docs/api/debug-mode.md`:
```markdown
# Debug Mode Guide

## Enabling Debug Mode
Add `debug=1` parameter to any search request.

## Debug Output Structure
- `query_processing`: Normalization, language detection, stopword filtering
- `retrieval_stages`: BM25 retrieval, n-gram fallback, deduplication
- `timing_breakdown`: Latency by stage (ms)

## Ranking Features
- `bm25_score`: Lexical relevance (0-100+)
- `embedding_similarity`: Semantic similarity (0-1)
- `hostrank`: Domain authority (0-1)
- `anchor_match`: Anchor text relevance (0-1)
- `structured_boost`: Schema.org bonus (1.0-1.5)
- `freshness_decay`: Recency factor (0-1)
- `url_quality`: URL pattern quality (0-1)
- `spamness`: Spam probability (0-1, lower is better)
- `intent_align`: Intent match score (0-1)
- `final_score`: Weighted combination

## Use Cases
- Debugging ranking issues
- Understanding query processing
- Optimizing search quality
- Training and testing
```

## Notes

### Best Practices
1. **API First:** Keep spec in sync with implementation
2. **Examples Everywhere:** Every parameter needs an example
3. **Versioning:** Use semantic versioning for API changes
4. **Deprecation:** Give clear migration paths for deprecated features
5. **Testing:** Automate API contract testing in CI/CD

### Common Pitfalls
- âŒ Spec diverges from actual API implementation
- âŒ Missing or incorrect example requests/responses
- âŒ Undocumented error codes
- âŒ No multi-language examples
- âŒ Debug mode not documented

### Tools & Resources
- [OpenAPI Specification](https://spec.openapis.org/oas/v3.0.0)
- [Swagger Editor](https://editor.swagger.io/)
- [Swagger UI](https://swagger.io/tools/swagger-ui/)
- [Schemathesis](https://schemathesis.readthedocs.io/) - API contract testing
- [ReDoc](https://github.com/Redocly/redoc) - Alternative API docs

## Success Metrics
- API documentation viewed 100+ times/month
- Zero incidents from API misunderstanding
- Frontend integration time reduced by 50%
- Positive developer experience feedback (NPS >8)
- 100% API contract test coverage

## Related Tasks
- 15.1 - Architecture Diagrams (references API architecture)
- 15.3 - Feature Glossary (explains ranking features)
- 15.4 - Troubleshooting Runbooks (uses debug mode)
- 09.8 - End-to-End Integration (implements API endpoints)

---

**Celebration Criteria:** ðŸŽ‰
- OpenAPI spec complete and validated
- Swagger UI deployed and functional
- Multi-language examples working for 10+ languages
- Positive feedback from frontend team on documentation quality


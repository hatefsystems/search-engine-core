name: üê≥ Docker Build Orchestrator

on:
  workflow_call:
    inputs:
      docker_image:
        required: false
        type: string
      docker_tag:
        required: false
        type: string
      cache_version:
        required: false
        type: string
        default: '1'
      force_rebuild:
        description: 'Force rebuild all images even if unchanged'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  actions: write

jobs:
  build-drivers:
    uses: ./.github/workflows/build-mongodb-drivers.yml
    with:
      docker_image: ghcr.io/${{ github.repository }}/mongodb-drivers
      docker_tag: latest

  build-js-minifier:
    needs: build-drivers
    uses: ./.github/workflows/build-js-minifier.yml
    with:
      docker_image: ghcr.io/${{ github.repository }}/js-minifier
      docker_tag: latest

  build-redis-sync:
    uses: ./.github/workflows/build-redis-sync.yml
    with:
      docker_image: ghcr.io/${{ github.repository }}/redis-sync
      docker_tag: latest

  build-crawler-scheduler:
    uses: ./.github/workflows/build-crawler-scheduler.yml
    with:
      docker_image: ghcr.io/${{ github.repository }}/crawler-scheduler
      docker_tag: latest
      cache_version: ${{ inputs.cache_version }}
      force_rebuild: ${{ inputs.force_rebuild }}

  build-app:
    needs: [build-drivers, build-js-minifier]
    uses: ./.github/workflows/build-search-engine.yml
    with:
      docker_image: ghcr.io/${{ github.repository }}
      docker_tag: latest
      cache_version: ${{ inputs.cache_version }}

